--CAU 1--
USE QLBanhang;
GO
CREATE TRIGGER TRG_CHITIETHOADON_GIABAN
ON CHITIETHOADON
AFTER INSERT, UPDATE
AS	
	BEGIN
	DECLARE @GIABAN AS MONEY;
	DECLARE @GIAMUA AS MONEY;
	SELECT @GIABAN = inserted.GIABAN, @GIAMUA = VATTU.GIAMUA 
	FROM inserted JOIN VATTU ON inserted.MAVT = VATTU.MAVT;
	IF(@GIABAN < @GIAMUA)
		BEGIN	
			ROLLBACK;
		END
	END
GO
--CAU 2--
USE QLBanhang;
GO
CREATE TRIGGER TRG_CHITIETHOADON_SL
ON CHITIETHOADON
AFTER INSERT
AS
BEGIN
UPDATE VATTU
SET SLTON = SLTON - inserted.SL
FROM VATTU
JOIN inserted
ON VATTU.MAVT = inserted.MAVT;
END
GO
--CAU 3--
USE QLBanhang;
GO
CREATE TRIGGER TRG_CHITIETHOADON_GIABAN_UPDATE
ON CHITIETHOADON
AFTER UPDATE
AS
BEGIN
DECLARE @GIACURRENT AS MONEY;
DECLARE @GIAUPDATE AS MONEY;
SELECT @GIACURRENT = C1.GIABAN FROM CHITIETHOADON C1 JOIN deleted ON C1.MAHD = deleted.MAHD AND C1.MAVT = deleted.MAVT;
SELECT @GIAUPDATE = C2.GIABAN FROM CHITIETHOADON C2 JOIN inserted ON C2.MAHD = inserted.MAHD AND C2.MAVT = inserted.MAVT;
IF(@GIAUPDATE < @GIACURRENT)
	BEGIN
	ROLLBACK;
	END
END
GO
--CAU 4--
USE QLBanhang;
GO
CREATE TRIGGER TG_CHITIETHOADON
ON CHITIETHOADON
AFTER INSERT, DELETE, UPDATE
AS
BEGIN
UPDATE HOADON
SET TONGTG = TONGTG + (SELECT SUM(inserted.GIABAN) FROM inserted WHERE inserted.MAHD = H1.MAHD)
FROM HOADON H1
JOIN inserted
ON inserted.MAHD = H1.MAHD;
UPDATE HOADON
SET TONGTG = TONGTG - (SELECT SUM(deleted.GIABAN) FROM deleted WHERE deleted.MAHD = H2.MAHD)
FROM HOADON H2
JOIN deleted
ON deleted.MAHD = H2.MAHD;
END
GO

BEGIN TRANSACTION
DELETE FROM CHITIETHOADON WHERE MAVT = 'VT01' AND MAHD = 'HD001';
UPDATE CHITIETHOADON SET GIABAN = 1000 WHERE MAVT = 'VT03' AND MAHD = 'HD002';
SELECT * FROM HOADON
ROLLBACK TRANSACTION
SELECT * FROM HOADON
